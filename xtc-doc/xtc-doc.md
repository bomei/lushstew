比特币白话
====

### 1.区块链

要介绍比特币，首先要了解区块链。在比特币的范畴里，区块链上的一个区块就是包含了有数个交易（transaction）的记录，矿工从内存池中挑选一部分交易，通过不断的哈希把这些交易放到一个[merkle树](https://yeasy.gitbooks.io/blockchain_guide/content/crypto/merkle_trie.html)里，最后得到一个树根的哈希。把最后这个哈希加上一段数据，使得这个组合数据的哈希满足设定条件（一般为小于某个值），这个块就算是挖到了。由于哈希算法无法由输出反推输入，所以给merkle树的树根附加一个什么值，只能暴搜得出。暴搜，显而易见的，就是=要求机器有足够的运算能力。目标值越小，找到这个附加数据的难度越大，要求的算力就越高，因此调整这个目标值就可以调整挖矿难度。

### 2.交易

比特币中的交易由n个UTXO作为输入和m个UTXO输出构成。一个交易在创建完成到被确认（即被矿工计算放入某个区块中）之前，都会放在内存池中。

UTXO（Unspent Transaction Output）可以类比为一个记录了比特币数量和一个解锁脚本的数据结构。只要满足解锁脚本条件的，都可以使用这个UTXO中携带的比特币。满足解锁脚本的条件可能是：
* 一个账户的签名，表明这个账户独立地拥有这个UTXO；
* m个账户中n个的的签名（multisig）：这m个账户中有n个签名之后，这个UTXO就可以作为一个合法的交易输入；
* 其他更为复杂的解锁条件：在解锁脚本中还可以加入时间等条件语句，构造更为复杂的解锁脚本，也就是所谓的智能合约。


矿工挖矿成功会产生一个特殊的UTXO，叫创币（coinbase）交易，这个交易的输入中会有一个特殊字段coinbase，输出就是一个属于矿工的UTXO。创币交易的奖励随着时间的推移会逐渐减半再减半，直到所有2100万个比特币都分发完毕后，矿工将不会再得到创币奖励，只从交易费中收取挖矿报酬。


UTXO是不可分割的，每次使用都会将整个UTXO全部消耗。比如：

* Alex账户中有一个10btc的UTXO，她要给Bob转账2btc，那么在不考虑交易费的情况下，这个交易的输入是这个来自Alex的10btc的UTXO，输出是一个属于Bob的2btc的UTXO和一个属于Alex的8btc的UTXO。
* Alex账户中有两个1btc的UTXO，他要给Bob转账1.5btc，同样在不考虑交易费的情况下，这个交易的输入是两个来自Alex的1btc的UTXO，输出是一个属于Bob的1.5btc的UTXO和一个属于Alex的0.5btc的UTXO。

输出中属于Alex的那个UTXO，叫做“找零”。

### 3.交易费

一个交易的交易费 = 所有输入UTXO中比特币的总额 - 所有输出UTXO中比特币的总额

在上述两个交易的例子中，一般的情况可能是：
* 输入10btc的UTXO，输出一个2btc的UTXO和一个7.9999btc的UTXO，中间相差的0.0001btc就是作为交易费。
* 输入两个1btc的UTXO，输出一个1.5btc的UTXO和一个0.4999btc的UTXO，中间相差同样的0.0001btc也是作为交易费。

一般交易费从找零中扣除。（当然要是收钱的人愿意从他的UTXO输出扣也不是不可以）


当一笔交易被放入某个区块后，这笔交易中的交易费将会作为对矿工的奖励发送到矿工账户。

由于上述原因，矿工在计算一个区块时，必然会优先选择交易费高的交易进行计算，以获取最大利益。对于某些没有交易费或是交易费很低的交易，就很难得到确认了。

关于交易费和平均确认时间，可以在[这里](https://bitcoinfees.earn.com/)查看。

#### 一些关于交易费的骚操作

1. 加速确认服务：当一笔交易的交易费太低时，给某个矿池多付一笔钱，将交易ID（txid）发给矿池，矿池会特意将这个txid打包进之后的区块中去，交易便能得到确认。
2. RBF功能：在`sendrawtransaction`时，把第二个参数给True，表明这个交易不是最终版本（实际就是交易中sequence字段不是0xffffffff）。可以构造一个新交易，增加其中的交易费（即减少输出UTXO中比特币的总额，差不多就是减少找零了），重新签名，发送。查看这两个交易的状态，原交易会变为`Status: 0/unconfirmed, not in memory pool`，而新交易会变为`Status: 0/unconfirmed, in memory pool`，这样老交易就不会再被确认了。

很多钱包都提供修改交易费的功能，也可能通过直接构建`rawtransaction`来指定交易费。

按照当前的情况，交易费一般和交易脚本的大小成正比的，一个交易中包含的UTXO越多，体积就会越大，意味着更多的交易费。由于这个原因和其他一些原因，隔离见证（segwit）出现了。

### 4.隔离见证

隔离见证把原本放到交易中的内容抽出一部分放到见证脚本中，把一部分交易费从自己身上转移到这个交易的接受者身上，减少了自己的支出。隔离见证使用隔离见证的地址。**（RETARD ALERT）隔离见证需要钱包的支持，当双方钱包都支持隔离见证时，便使用隔离见证的方式交易，否则还是使用传统方式交易。**